---

- name: Creates {{ typo3_source_path }}/cms directory
  file: path={{ typo3_source_path }}/cms state=directory owner={{ typo3.cms.sources.owner | default('vagrant') }} group={{ typo3.cms.sources.group | default('www-data') }} mode=0775

- name: Creates {{ typo3_source_path }}/homestead directory
  file: path={{ typo3_source_path }}/homestead state=directory owner={{ typo3.cms.sources.owner | default('vagrant') }} group={{ typo3.cms.sources.group | default('www-data') }} mode=0775

- name: Setup homestead default site
  sudo: vagrant
  copy: src=index.html dest={{ typo3_source_path }}/homestead/index.html

- name: Clone TYPO3 CMS
  sudo: "{{ typo3.cms.sources.owner | default('vagrant') }}"
  git: repo=git://git.typo3.org/Packages/TYPO3.CMS.git
       dest={{ typo3_source_path }}/cms/typo3-cms

- name: Generate ssl certificates for nginx sites (needs to run before nginx role)
  command: openssl req -x509 -sha512 -nodes -days 3650 -subj '/C=NL/ST=Noord-Brabant/L=Giessen/CN={{ item }}' -newkey rsa:4096 -keyout {{nginx_conf_dir}}/ssl/{{ item }}.key -out {{nginx_conf_dir}}/ssl/{{ item }}.crt
  with_items: nginx_sites.keys()
  notify:
    - reload nginx
  tags: [configuration,nginx,ssl]
